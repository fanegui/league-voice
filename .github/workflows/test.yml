name: Test
on:
    push:
        branches: ["*"]
    pull_request:
        branches: ["*"]

env:
    CARGO_TERM_COLOR: always

jobs:
    build:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4

            - name: Audio device
              run: Get-CimInstance Win32_SoundDevice | fl *
            - name: Install Scream
              shell: powershell
              run: |
                  Start-Service audio*
                  Invoke-WebRequest https://github.com/duncanthrax/scream/releases/download/3.6/Scream3.6.zip -OutFile C:\Scream3.6.zip
                  Extract-7Zip -Path C:\Scream3.6.zip -DestinationPath C:\Scream
                  $cert = (Get-AuthenticodeSignature C:\Scream\Install\driver\Scream.sys).SignerCertificate
                  $store = [System.Security.Cryptography.X509Certificates.X509Store]::new("TrustedPublisher", "LocalMachine")
                  $store.Open("ReadWrite")
                  $store.Add($cert)
                  $store.Close()
                  cd C:\Scream\Install\driver
                  C:\Scream\Install\helpers\devcon install Scream.inf *Scream
            - name: Audio device
              run: Get-CimInstance Win32_SoundDevice | fl *
            - name: Install tar
              run: cargo install cargo-tarpaulin
            - name: Build
              run: cargo build --verbose
            - name: Generate coverage report
              run: cargo tarpaulin --out Xml
            - name: Code Coverage Summary Report
              uses: irongut/CodeCoverageSummary@v1.3.0
              with:
                  filename: cobertura.xml
                  badge: true
                  fail_below_min: 100
                  thresholds: 100

            - name: Add Coverage PR Comment
              uses: marocchino/sticky-pull-request-comment@v2
              if: github.event_name == 'pull_request'
              with:
                  recreate: true
                  path: code-coverage-results.md

            - name: Coveralls
              uses: coverallsapp/github-action@v2
              with:
                  path-to-lcov: ./cobertura.xml
                  format: cobertura
